services:
  db:
    image: postgres:16-alpine
    restart: always  # <-- Ensures DB starts if server reboots
    volumes:
      - postgres_production_data:/var/lib/postgresql/data
    environment:
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD} # <-- Loaded from .env
    # No ports exposed! Web/Worker talk to it internally.

  redis:
    image: redis:7-alpine
    restart: always
    volumes:
      - redis_production_data:/data

  web:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    # NO VOLUMES! Uses code already inside the image
    ports:
      - "80:80" # <-- Uses Thruster (port 80) as defined in your Dockerfile
    environment:
      RAILS_ENV: production
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY}
      DATABASE_HOST: db
      REDIS_URL: redis://redis:6379/1
    depends_on:
      - db
      - redis

  sidekiq:
    build: .
    restart: always
    command: bundle exec sidekiq
    environment:
      RAILS_ENV: production
      RAILS_MASTER_KEY: ${RAILS_MASTER_KEY}
      DATABASE_HOST: db
      REDIS_URL: redis://redis:6379/1
    depends_on:
      - db
      - redis

# rspec service is REMOVED (no tests in production)

volumes:
  postgres_production_data:
  redis_production_data: